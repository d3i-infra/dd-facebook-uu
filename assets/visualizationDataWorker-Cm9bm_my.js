(function(){"use strict";function D(n,e,t=10){let r=n;const u=n.map(o=>new Date(o).getTime());let a=null,l=o=>o.toISOString();e==="auto"&&(e=b(u,t)),e==="year"&&(l=o=>o.getFullYear().toString()),e==="quarter"&&(l=o=>{const c=o.getFullYear().toString(),g=Math.floor(o.getMonth()/3)+1;return`${c}-Q${g}`}),e==="month"&&(l=o=>{const c=o.getFullYear().toString(),g=o.toLocaleString("default",{month:"short"});return`${c}-${g}`}),e==="day"&&(l=o=>{const c=o.getFullYear().toString(),g=o.toLocaleString("default",{month:"short"}),y=o.getDate().toString();return`${c}-${g}-${y}`}),e==="hour"&&(l=o=>{const c=o.getFullYear().toString(),g=o.toLocaleString("default",{month:"short"}),y=o.getDate().toString(),h=o.getHours();return`${c}-${g}-${y} ${h}:00`}),e==="month_cycle"&&(l=o=>new Intl.DateTimeFormat("default",{month:"long"}).format(o),a=[new Date("2000-01-01").getTime(),new Date("2001-01-01").getTime()]),e==="weekday_cycle"&&(l=o=>new Intl.DateTimeFormat("default",{weekday:"long"}).format(o),a=[new Date("2023-11-06").getTime(),new Date("2023-11-13").getTime()]),e==="hour_cycle"&&(l=o=>new Intl.DateTimeFormat("default",{hour:"numeric",hour12:!1}).format(o),a=[new Date("2000-01-01").getTime(),new Date("2000-01-02").getTime()]),r=u.map(o=>l(new Date(o))),a==null&&(a=w(u));const f=F(a,e,l);return[r,f]}function b(n,e){const[t,r]=w(n);let u="hour";return r-t>1e3*60*60*24*e&&(u="day"),r-t>1e3*60*60*24*30*e&&(u="month"),r-t>1e3*60*60*24*30*3*e&&(u="quarter"),r-t>1e3*60*60*24*365*e&&(u="year"),u}function F(n,e,t){const r={},[u,a]=n;let l=0;if(e==="year"&&(l=1e3*60*60*24*364),e==="quarter"&&(l=1e3*60*60*24*28*3),["month","month_cycle"].includes(e)&&(l=1e3*60*60*24*28),["day","weekday_cycle"].includes(e)&&(l=1e3*60*60*24),["hour","hour_cycle"].includes(e)&&(l=1e3*60*60),l>0)for(let f=u;f<=a;f+=l){const o=new Date(f),c=t(o);r[c]===void 0&&(r[c]=f)}return r}function w(n){let e=n[0],t=n[0];return n.forEach(r=>{r<e&&(e=r),r>t&&(t=r)}),[e,t]}function $(n){return n.split(" ").filter(t=>new RegExp("\\p{L}","giu").test(t))}function p(n,e){if(e===".COUNT")return Array(n.body.rows.length).fill("1");const t=n.head.cells.findIndex(r=>r===e);if(t<0)throw new Error(`column ${n.id}.${e} not found`);return n.body.rows.map(r=>r.cells[t])}function T(n){let e;try{e=new URL(n).hostname.replace(/^www\./,"").replace(/^m\./,"")}catch{e=n}return e.trim()}async function _(n,e){if(n.body.rows.length===0)return{type:e.type,xKey:"",xLabel:"",yKeys:{},data:[]};const t=k(n,e);return x(n,e,t)}function x(n,e,t){const r=S(n,e);return r.data=Object.values(t).sort((u,a)=>u.sortBy<a.sortBy?-1:a.sortBy<u.sortBy?1:0).map(u=>{for(const a of Object.keys(u.values))u.values[a]=Math.round(u.values[a]*100)/100;return{...u.values,[u.xKey]:u.xValue,__rowIds:u.rowIds,__sortBy:u.sortBy}}),r}function S(n,e){const t={};for(const r of e.values){let u="default";if((r.aggregate==="pct"||r.aggregate==="count_pct")&&(u="percent"),r.group_by===void 0){const a=r.label!==void 0?r.label:r.column;t[r.column]={id:r.column,label:a,tickerFormat:u}}else{const a=Array.from(new Set(p(n,r.group_by)));for(const l of a){const f=`${r.column}.GROUP_BY.${l}`;t[f]={id:f,label:l,tickerFormat:u}}}}return{type:e.type,xKey:e.group.column,xLabel:e.group.label,yKeys:t,data:[]}}function k(n,e){const t={},{groupBy:r,xSortable:u}=I(n,e),a=n.body.rows.map(o=>o.id),l=e.group.column;if(e.values.some(o=>o.addZeroes===!0)&&u!=null)for(const[o,c]of Object.entries(u))t[o]={sortBy:c,rowIds:{},xKey:l,xValue:o,values:{}};for(const o of e.values){const c=o.aggregate!==void 0?o.aggregate:"count",g=p(n,o.column);if(g.length===0)throw new Error(`Y column ${n.id}.${o.column} not found`);let y=null;o.group_by!==void 0&&(y=p(n,o.group_by).map(i=>`${o.column}.GROUP_BY.${i}`));const h=o.addZeroes??!1,d={};for(let i=0;i<a.length;i++){const s=r[i];if(e.group.range!==void 0&&(Number(s)<e.group.range[0]||Number(s)>e.group.range[1]))continue;const v=g[i],m=y!=null?y[i]:o.column,O=u!=null?u[s]:r[i];d[m]===void 0&&(d[m]={n:0,sum:0}),(c==="count_pct"||c==="mean")&&(d[m].n+=1),c==="pct"&&(d[m].sum+=Number(v)??0),t[s]===void 0&&(t[s]={sortBy:O,rowIds:{},xKey:l,xValue:String(s),values:{}}),t[s].rowIds[m]===void 0&&(t[s].rowIds[m]=[]),t[s].rowIds[m].push(a[i]),t[s].values[m]===void 0&&(t[s].values[m]=0),(c==="count"||c==="count_pct")&&(t[s].values[m]+=1),(c==="sum"||c==="mean"||c==="pct")&&(t[s].values[m]+=Number(v)??0)}Object.keys(d).forEach(i=>{for(const s of Object.keys(t)){if(t[s].values[i]===void 0)if(h)t[s].values[i]=0;else continue;c==="mean"&&(t[s].values[i]=Number(t[s].values[i])/d[i].n),c==="count_pct"&&(t[s].values[i]=100*Number(t[s].values[i])/d[i].n),c==="pct"&&(t[s].values[i]=100*Number(t[s].values[i])/d[i].sum)}})}return t}function I(n,e){let t=p(n,e.group.column);if(t.length===0)throw new Error(`X column ${n.id}.${e.group.column} not found`);let r=null;if(e.group.dateFormat!==void 0&&([t,r]=D(t,e.group.dateFormat)),e.group.levels!==void 0){r={};for(let u=0;u<e.group.levels.length;u++){const a=e.group.levels[u];r[a]=u}}return{groupBy:t,xSortable:r}}async function N(n,e){const t={type:e.type,topTerms:[]};if(n.body.rows.length===0)return t;const r=p(n,e.textColumn),u=e.valueColumn!=null?p(n,e.valueColumn):null,a=B(r,u,e);return t.topTerms=V(a,r.length,200),t}function B(n,e,t){const r={};for(let u=0;u<n.length;u++){if(n?.[u]==null)continue;const a=n[u],l=t.tokenize!=null&&t.tokenize?$(a):[a],f=new Set;for(let o of l){t.extract==="url_domain"&&(o=T(o)),r[o]===void 0&&(r[o]={value:0,docFreq:0}),f.has(o)||(r[o].docFreq+=1,f.add(o));const c=e!=null?Number(e[u])??1:1;isNaN(c)||(r[o].value+=c)}}return r}function V(n,e,t){return Object.entries(n).map(([r,u])=>{const a=u.value,l=Math.log(e/u.docFreq);return{text:r,value:u.value,importance:a*l}}).sort((r,u)=>u.importance-r.importance).slice(0,t)}self.onmessage=n=>{q(n.data.table,n.data.visualization).then(e=>{self.postMessage({status:"success",visualizationData:e})}).catch(e=>{console.error(e),self.postMessage({status:"error",visualizationData:void 0})})};async function q(n,e){if(n===void 0||e===void 0)throw new Error("Table and visualization are required");if(["line","bar","area"].includes(e.type))return await _(n,e);if(["wordcloud"].includes(e.type))return await N(n,e);throw new Error(`Visualization type ${e.type} not supported`)}})();
//# sourceMappingURL=visualizationDataWorker-Cm9bm_my.js.map
